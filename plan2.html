<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POP! Planner</title>
    
    <!-- 1. Load React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 2. Load Babel (to understand JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. Load Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e' }
                    }
                }
            }
        }
    </script>
    
    <!-- 4. Load Firebase (Compat version) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyD-8NTdlSAaVumj4WWRd0hO1x49D8s3Zgw",
            authDomain: "planner-bcd70.firebaseapp.com",
            projectId: "planner-bcd70",
            storageBucket: "planner-bcd70.firebasestorage.app",
            messagingSenderId: "56263069136",
            appId: "1:56263069136:web:89f22b5c45c566e13c3dd5",
            measurementId: "G-V6ZD0QP9QN"
        };
        
        // --- APP LOGIC ---
        let auth, db;
        const isConfigured = firebaseConfig.apiKey && firebaseConfig.apiKey !== "AIzaSyYOUR_API_KEY_HERE";

        if (isConfigured) {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
        }

        const appId = "pop-planner-web"; 
        const { useState, useEffect, useRef } = React;

        // --- THEME CONFIG ---
        const THEMES = {
            blue: { name: 'Funko Blue', primary: 'bg-blue-600', hover: 'hover:bg-blue-700', text: 'text-blue-500', border: 'border-blue-500', ring: 'focus:ring-blue-500' },
            purple: { name: 'Chase Purple', primary: 'bg-purple-600', hover: 'hover:bg-purple-700', text: 'text-purple-500', border: 'border-purple-500', ring: 'focus:ring-purple-500' },
            green: { name: 'ECCC Green', primary: 'bg-emerald-600', hover: 'hover:bg-emerald-700', text: 'text-emerald-500', border: 'border-emerald-500', ring: 'focus:ring-emerald-500' },
            pink: { name: 'Valentine Pink', primary: 'bg-pink-600', hover: 'hover:bg-pink-700', text: 'text-pink-500', border: 'border-pink-500', ring: 'focus:ring-pink-500' },
            orange: { name: 'Halloween', primary: 'bg-orange-600', hover: 'hover:bg-orange-700', text: 'text-orange-500', border: 'border-orange-500', ring: 'focus:ring-orange-500' },
        };

        const Icon = ({ name, size = 18, className = "" }) => {
            const icons = {
                plus: <path d="M5 12h14M12 5v14" />,
                image: <><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><circle cx="9" cy="9" r="2" /><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" /></>,
                x: <path d="M18 6 6 18M6 6l12 12" />,
                trash2: <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6" />,
                copy: <><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></>,
                grid: <><rect width="7" height="7" x="3" y="3" rx="1" /><rect width="7" height="7" x="14" y="3" rx="1" /><rect width="7" height="7" x="14" y="14" rx="1" /><rect width="7" height="7" x="3" y="14" rx="1" /></>,
                list: <><line x1="8" x2="21" y1="6" y2="6" /><line x1="8" x2="21" y1="12" y2="12" /><line x1="8" x2="21" y1="18" y2="18" /><line x1="3" x2="3.01" y1="6" y2="6" /><line x1="3" x2="3.01" y1="12" y2="12" /><line x1="3" x2="3.01" y1="18" y2="18" /></>,
                columns: <path d="M12 3h7a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-7m0-18H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7m0-18v18" />,
                save: <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></>,
                moon: <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />,
                sun: <><circle cx="12" cy="12" r="4" /><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41" /></>,
                cloud: <><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19" /><path d="M19 19H5a3 3 0 1 1 .55-5.94A7 7 0 1 1 19 19Z" /></>,
                wifi: <><path d="M5 12.55a11 11 0 0 1 14.08 0" /><path d="M1.42 9a16 16 0 0 1 21.16 0" /><path d="M8.53 16.11a6 6 0 0 1 6.95 0" /><line x1="12" x2="12.01" y1="20" y2="20" /></>,
                wifiOff: <><line x1="1" x2="23" y1="1" y2="23" /><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55" /><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39" /><path d="M10.71 5.05A16 16 0 0 1 22.58 9" /><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88" /><path d="M8.53 16.11a6 6 0 0 1 6.95 0" /><line x1="12" x2="12.01" y1="20" y2="20" /></>,
                twitter: <path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.6 5.6 4.1 9 4-.9-4.2 4-6.6 7-3.8 1.1 0 3-1.2 3-1.2z" />,
                hash: <><line x1="4" x2="20" y1="9" y2="9" /><line x1="4" x2="20" y1="15" y2="15" /><line x1="10" x2="8" y1="3" y2="21" /><line x1="16" x2="14" y1="3" y2="21" /></>,
                link: <><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></>,
                zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />,
                star: <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />,
                tag: <><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z" /><path d="M7 7h.01" /></>,
                database: <><ellipse cx="12" cy="5" rx="9" ry="3" /><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" /><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" /></>,
                clock: <><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></>,
                lock: <><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>,
                user: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></>,
                logout: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" x2="9" y1="12" y2="12" /></>,
                settings: <><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></>,
                loader2: <path d="M21 12a9 9 0 1 1-6.219-8.56" />
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name]}</svg>;
        };

        const QUICK_LINKS = [
            { name: 'EE', url: ' fnkpp.com/EE ', color: 'bg-purple-100 text-purple-700 border-purple-200' },
            { name: 'Funko Shop', url: ' fnkpp.com/FS ', color: 'bg-blue-100 text-blue-700 border-blue-200' },
            { name: 'Hot Topic', url: ' fnkpp.com/HT ', color: 'bg-red-100 text-red-700 border-red-200' },
            { name: 'Box Lunch', url: ' fnkpp.com/BL ', color: 'bg-teal-100 text-teal-700 border-teal-200' },
            { name: 'Amazon', url: ' fnkpp.com/Amzn ', color: 'bg-yellow-100 text-yellow-700 border-yellow-200' },
        ];
        const RETAILERS = [
            { keyword: 'target', label: 'Target', color: 'bg-red-600 text-white' },
            { keyword: 'amazon', label: 'Amazon', color: 'bg-yellow-500 text-black' },
            { keyword: 'hot topic', label: 'Hot Topic', color: 'bg-zinc-800 text-white' },
            { keyword: 'box lunch', label: 'Box Lunch', color: 'bg-teal-600 text-white' },
            { keyword: 'entertainment earth', label: 'EE', color: 'bg-purple-600 text-white' },
            { keyword: 'ee', label: 'EE', color: 'bg-purple-600 text-white' },
            { keyword: 'funko shop', label: 'Funko Shop', color: 'bg-blue-600 text-white' },
            { keyword: 'walmart', label: 'Walmart', color: 'bg-blue-500 text-white' },
        ];
        const DEFAULT_TAGS = "\n\n#Ad #FPN #FunkoPOPNews #Funko #FunkoPOP";

        function App() {
            // Check Config
            if (!isConfigured) return <SetupScreen />;

            // State
            const [user, setUser] = useState(null);
            const [drafts, setDrafts] = useState([]);
            const [loading, setLoading] = useState(true);
            
            // Visual State
            const [theme, setTheme] = useState('blue');
            const [darkMode, setDarkMode] = useState(true);
            const [layout, setLayout] = useState('grid'); // 'grid', 'feed', 'compact'
            const [showSettings, setShowSettings] = useState(false);

            // Editor State
            const [inputText, setInputText] = useState("");
            const [selectedImage, setSelectedImage] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const [pasteActive, setPasteActive] = useState(false);
            const [isPriority, setIsPriority] = useState(false);
            const [useWatermark, setUseWatermark] = useState(false);
            
            // Errors
            const [authError, setAuthError] = useState(null);
            const [systemError, setSystemError] = useState(null);

            const fileInputRef = useRef(null);
            const textareaRef = useRef(null);

            // 1. Auth Listener
            useEffect(() => {
                if (!auth) return;
                return auth.onAuthStateChanged(u => {
                    setUser(u);
                    if(u) setAuthError(null);
                });
            }, []);

            // 2. Data & Settings Sync
            useEffect(() => {
                if (!user || !db) return;
                setLoading(true);
                
                // Drafts Listener
                const draftsRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('drafts');
                const unsubDrafts = draftsRef.onSnapshot(snap => {
                    const fetched = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    fetched.sort((a,b) => (b.isPriority ? 1 : -1) || b.createdAt - a.createdAt);
                    setDrafts(fetched);
                    setLoading(false);
                }, err => handleSystemError(err));

                // Settings Listener (User Preference Persistence)
                const prefRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('settings').doc('preferences');
                const unsubPrefs = prefRef.onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.theme) setTheme(data.theme);
                        if (data.layout) setLayout(data.layout);
                        // Explicit check for undefined to allow 'false'
                        if (data.darkMode !== undefined) setDarkMode(data.darkMode); 
                    }
                });

                return () => { unsubDrafts(); unsubPrefs(); };
            }, [user]);

            // 3. Apply Dark Mode
            useEffect(() => {
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [darkMode]);

            // Save Preferences
            const savePreferences = async (newTheme, newDark, newLayout) => {
                if(!user) return;
                // Update local state immediately for snappy feel
                if(newTheme !== undefined) setTheme(newTheme);
                if(newDark !== undefined) setDarkMode(newDark);
                if(newLayout !== undefined) setLayout(newLayout);

                // Debounce/Save to cloud
                const prefRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('settings').doc('preferences');
                await prefRef.set({
                    theme: newTheme !== undefined ? newTheme : theme,
                    darkMode: newDark !== undefined ? newDark : darkMode,
                    layout: newLayout !== undefined ? newLayout : layout
                }, { merge: true });
            };

            // Handlers
            const handleSystemError = (err) => {
                console.error(err);
                if (err.code === 'permission-denied') setSystemError('permission');
                else if (err.code === 'not-found') setSystemError('not-found');
                else setSystemError('unknown');
            };

            const processImage = (base64Str, watermark) => {
                return new Promise(resolve => {
                    const img = new Image();
                    img.src = base64Str;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const maxW = 1000;
                        let w = img.width;
                        let h = img.height;
                        if (w > maxW) { h *= maxW/w; w = maxW; }
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        
                        if (watermark) {
                            const text = "@FunkoPOPsNews";
                            const fs = Math.max(20, w * 0.05);
                            ctx.font = `bold ${fs}px sans-serif`;
                            ctx.fillStyle = "rgba(255,255,255,0.8)";
                            ctx.strokeStyle = "rgba(0,0,0,0.5)";
                            ctx.lineWidth = 4;
                            ctx.textAlign = "right";
                            ctx.textBaseline = "bottom";
                            const pad = w * 0.03;
                            ctx.strokeText(text, w - pad, h - pad);
                            ctx.fillText(text, w - pad, h - pad);
                        }
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                });
            };

            const handlePaste = async (e) => {
                if (!e.clipboardData.items) return;
                for (let i = 0; i < e.clipboardData.items.length; i++) {
                    const item = e.clipboardData.items[i];
                    if (item.type.indexOf("image") !== -1) {
                        e.preventDefault();
                        setPasteActive(true);
                        const blob = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = async (evt) => {
                            const processed = await processImage(evt.target.result, false);
                            setSelectedImage(processed);
                            setPasteActive(false);
                        };
                        reader.readAsDataURL(blob);
                    }
                }
            };

            useEffect(() => {
                window.addEventListener('paste', handlePaste);
                return () => window.removeEventListener('paste', handlePaste);
            }, []);

            const saveDraft = async () => {
                if ((!inputText.trim() && !selectedImage) || !user) return;
                setIsSaving(true);
                try {
                    let img = selectedImage;
                    if (img && useWatermark) img = await processImage(img, true);
                    
                    await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('drafts').add({
                        text: inputText,
                        image: img,
                        date: new Date().toLocaleString(),
                        createdAt: Date.now(),
                        isPriority,
                        status: 'draft'
                    });
                    setInputText("");
                    setSelectedImage(null);
                    setIsPriority(false);
                    setUseWatermark(false);
                } catch(e) { console.error(e); alert("Save failed"); }
                finally { setIsSaving(false); }
            };

            // Render Logic
            if (!user) return <AuthScreen auth={auth} error={authError} setError={setAuthError} />;
            if (systemError) return <ErrorScreen type={systemError} config={firebaseConfig} />;

            const T = THEMES[theme]; // Active Theme Config

            return (
                <div className={`min-h-screen ${darkMode ? 'text-slate-100' : 'text-slate-900'} pb-20`}>
                    
                    {/* Paste Overlay */}
                    {pasteActive && (
                        <div className="fixed inset-0 z-50 bg-blue-500/20 backdrop-blur-sm flex items-center justify-center pointer-events-none">
                            <div className={`${T.primary} text-white px-6 py-3 rounded-xl font-bold text-xl shadow-xl animate-bounce`}>
                                Processing Image...
                            </div>
                        </div>
                    )}

                    {/* Nav */}
                    <nav className={`sticky top-0 z-40 border-b backdrop-blur-md ${darkMode ? 'bg-slate-900/80 border-slate-700' : 'bg-white/80 border-slate-200'}`}>
                        <div className="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className={`w-8 h-8 rounded-lg flex items-center justify-center transform -rotate-6 shadow-lg ${T.primary}`}>
                                    <span className="text-white font-black text-lg">P!</span>
                                </div>
                                <h1 className="font-bold text-xl tracking-tight hidden sm:block">POP! Planner</h1>
                            </div>
                            
                            <div className="flex items-center gap-2">
                                <div className={`flex items-center rounded-lg p-1 border ${darkMode ? 'border-slate-700' : 'border-slate-200'}`}>
                                    <button onClick={() => savePreferences(undefined, undefined, 'grid')} className={`p-1.5 rounded ${layout==='grid' ? (darkMode?'bg-slate-700':'bg-slate-100') : 'opacity-50'}`}><Icon name="grid"/></button>
                                    <button onClick={() => savePreferences(undefined, undefined, 'feed')} className={`p-1.5 rounded ${layout==='feed' ? (darkMode?'bg-slate-700':'bg-slate-100') : 'opacity-50'}`}><Icon name="columns"/></button>
                                    <button onClick={() => savePreferences(undefined, undefined, 'compact')} className={`p-1.5 rounded ${layout==='compact' ? (darkMode?'bg-slate-700':'bg-slate-100') : 'opacity-50'}`}><Icon name="list"/></button>
                                </div>
                                <button onClick={() => setShowSettings(!showSettings)} className={`p-2 rounded-full transition-colors ${showSettings ? T.text : 'text-slate-400 hover:text-slate-500'}`}>
                                    <Icon name="settings" size={20} />
                                </button>
                            </div>
                        </div>
                        
                        {/* Settings Dropdown Panel */}
                        {showSettings && (
                            <div className={`border-b ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-50 border-slate-200'}`}>
                                <div className="max-w-7xl mx-auto px-4 py-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-xs font-bold uppercase text-slate-500 mb-2 block">Color Theme</label>
                                        <div className="flex gap-2">
                                            {Object.keys(THEMES).map(k => (
                                                <button 
                                                    key={k} 
                                                    onClick={() => savePreferences(k, undefined, undefined)}
                                                    className={`w-8 h-8 rounded-full border-2 ${theme === k ? 'border-white ring-2 ring-slate-400' : 'border-transparent'} ${THEMES[k].primary}`}
                                                    title={THEMES[k].name}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                    <div className="flex items-center justify-between md:justify-end gap-4">
                                        <div>
                                            <label className="text-xs font-bold uppercase text-slate-500 mb-2 block">Display Mode</label>
                                            <button onClick={() => savePreferences(undefined, !darkMode, undefined)} className={`flex items-center gap-2 px-4 py-2 rounded-lg border ${darkMode ? 'border-slate-600 hover:bg-slate-700' : 'bg-white border-slate-200 hover:bg-slate-50'}`}>
                                                <Icon name={darkMode ? "moon" : "sun"} />
                                                <span>{darkMode ? "Dark Mode" : "Light Mode"}</span>
                                            </button>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold uppercase text-slate-500 mb-2 block">Account</label>
                                            <button onClick={() => auth.signOut()} className="flex items-center gap-2 px-4 py-2 rounded-lg border border-red-500/30 text-red-500 hover:bg-red-500/10">
                                                <Icon name="logout" />
                                                <span>Sign Out</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </nav>

                    <main className="max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
                        
                        {/* Composer (Left) */}
                        <div className="lg:col-span-4">
                            <div className={`sticky top-24 rounded-2xl p-4 shadow-xl border ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="font-semibold flex items-center gap-2">
                                        <Icon name="plus" className={T.text} /> New Idea
                                    </h2>
                                    <button 
                                        onClick={() => setInputText(prev => `ðŸš¨ FIRST LOOK! New Funko POPs revealed:\n\n[Details Here]\n${DEFAULT_TAGS}`)}
                                        className="text-xs bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded hover:opacity-80 transition-opacity"
                                    >
                                        First Look Template
                                    </button>
                                </div>

                                {selectedImage && (
                                    <div className="relative mb-4 group">
                                        <img src={selectedImage} className="w-full h-48 object-cover rounded-xl border border-slate-500/20" />
                                        <button onClick={() => setSelectedImage(null)} className="absolute top-2 right-2 bg-black/70 hover:bg-red-600 text-white p-1 rounded-full"><Icon name="x" size={14}/></button>
                                    </div>
                                )}

                                <div className="relative mb-3">
                                    <textarea
                                        ref={textareaRef}
                                        value={inputText}
                                        onChange={e => setInputText(e.target.value)}
                                        placeholder="Paste images or type news here..."
                                        className={`w-full h-32 p-3 pb-8 rounded-xl resize-none outline-none focus:ring-2 transition-all ${darkMode ? 'bg-slate-900 border-slate-700' : 'bg-slate-50 border-slate-200'} border ${T.ring}`}
                                    />
                                    <button onClick={() => { setInputText(p => p + DEFAULT_TAGS); textareaRef.current.focus(); }} className="absolute bottom-3 right-3 opacity-50 hover:opacity-100 p-1 rounded bg-slate-200 dark:bg-slate-700"><Icon name="hash" size={14} /></button>
                                </div>

                                {/* Quick Links */}
                                <div className="flex flex-wrap gap-2 mb-4">
                                    {QUICK_LINKS.map(l => (
                                        <button key={l.name} onClick={() => {
                                            const start = textareaRef.current.selectionStart;
                                            setInputText(v => v.slice(0, start) + l.url + v.slice(start));
                                        }} className={`text-[10px] px-2 py-1 rounded border opacity-80 hover:opacity-100 ${l.color}`}>{l.name}</button>
                                    ))}
                                </div>

                                {/* Actions */}
                                <div className="flex gap-2">
                                    <button onClick={() => setIsPriority(!isPriority)} className={`flex-1 py-2 rounded-lg text-xs font-bold border flex items-center justify-center gap-1 ${isPriority ? 'bg-red-500/10 text-red-500 border-red-500' : 'border-slate-500/20 opacity-70'}`}>
                                        <Icon name="star" size={14} className={isPriority ? 'fill-current' : ''} /> Priority
                                    </button>
                                    <button onClick={() => setUseWatermark(!useWatermark)} className={`flex-1 py-2 rounded-lg text-xs font-bold border flex items-center justify-center gap-1 ${useWatermark ? `${T.text} border-current bg-slate-500/10` : 'border-slate-500/20 opacity-70'}`}>
                                        <Icon name="tag" size={14} /> Watermark
                                    </button>
                                </div>

                                <div className="flex gap-2 mt-4">
                                    <button onClick={() => fileInputRef.current.click()} className={`p-3 rounded-xl border hover:bg-slate-50 dark:hover:bg-slate-700 ${darkMode ? 'border-slate-700' : 'border-slate-200'}`}>
                                        <Icon name="image" className={selectedImage ? T.text : 'text-slate-400'} />
                                    </button>
                                    <input type="file" ref={fileInputRef} onChange={e => {
                                        if(e.target.files[0]) {
                                            const r = new FileReader();
                                            r.onload = ev => processImage(ev.target.result, false).then(setSelectedImage);
                                            r.readAsDataURL(e.target.files[0]);
                                        }
                                    }} hidden accept="image/*" />
                                    
                                    <button onClick={saveDraft} disabled={isSaving || (!inputText && !selectedImage)} className={`flex-1 rounded-xl font-bold text-white flex items-center justify-center gap-2 ${T.primary} ${T.hover} disabled:opacity-50 disabled:cursor-not-allowed`}>
                                        {isSaving ? <Icon name="loader2" className="animate-spin" /> : <Icon name="save" />} Save
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Feed (Right) */}
                        <div className="lg:col-span-8">
                            {drafts.length === 0 && !loading && (
                                <div className={`text-center py-20 border-2 border-dashed rounded-3xl ${darkMode ? 'border-slate-800 text-slate-600' : 'border-slate-200 text-slate-400'}`}>
                                    <div className="w-16 h-16 bg-slate-500/10 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="cloud" size={32}/></div>
                                    <p>No drafts yet. Start planning!</p>
                                </div>
                            )}

                            <div className={`${
                                layout === 'grid' ? 'grid grid-cols-1 md:grid-cols-2 gap-4' : 
                                layout === 'compact' ? 'flex flex-col gap-2' : 
                                'flex flex-col gap-8' /* Feed mode */
                            }`}>
                                {drafts.map(d => (
                                    <div key={d.id} className={`group relative overflow-hidden rounded-xl border transition-all hover:shadow-lg ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'} ${d.isPriority ? 'ring-1 ring-red-500 border-red-500' : ''}`}>
                                        
                                        {/* Layout: Grid & Feed */}
                                        {layout !== 'compact' && d.image && (
                                            <div className={`relative ${layout === 'feed' ? 'w-full' : 'w-full h-48'} overflow-hidden bg-slate-900`}>
                                                <img src={d.image} className="w-full h-full object-contain" />
                                                {d.isPriority && <span className="absolute top-2 left-2 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded shadow">PRIORITY</span>}
                                            </div>
                                        )}

                                        <div className={`p-4 flex flex-col ${layout === 'compact' ? 'flex-row items-center gap-4' : ''}`}>
                                            {layout === 'compact' && d.image && (
                                                <img src={d.image} className="w-12 h-12 rounded object-cover bg-slate-800 shrink-0" />
                                            )}
                                            
                                            <div className="flex-grow min-w-0">
                                                {/* Retailer Badge Logic */}
                                                <div className="flex gap-2 mb-2">
                                                    {RETAILERS.map(r => (d.text || '').toLowerCase().includes(r.keyword) && (
                                                        <span key={r.label} className={`text-[10px] font-bold uppercase px-1.5 py-0.5 rounded ${r.color}`}>{r.label}</span>
                                                    ))}
                                                </div>
                                                <p className={`whitespace-pre-wrap text-sm leading-relaxed ${layout === 'compact' ? 'truncate' : ''}`}>
                                                    {d.text || <span className="italic opacity-50">Image only</span>}
                                                </p>
                                            </div>

                                            <div className={`flex items-center gap-2 ${layout === 'compact' ? '' : 'mt-4 pt-4 border-t ' + (darkMode ? 'border-slate-700' : 'border-slate-100')}`}>
                                                {layout !== 'compact' && <span className="text-xs opacity-50 flex-grow">{d.date.split(',')[0]}</span>}
                                                
                                                <button onClick={() => {
                                                    const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(d.text)}`;
                                                    window.open(url, '_blank');
                                                }} className={`p-2 rounded hover:bg-blue-500/10 hover:text-blue-500 text-slate-400`}><Icon name="twitter"/></button>
                                                
                                                <button onClick={() => {
                                                    const el = document.createElement('textarea');
                                                    el.value = d.text;
                                                    document.body.appendChild(el);
                                                    el.select();
                                                    document.execCommand('copy');
                                                    document.body.removeChild(el);
                                                }} className={`p-2 rounded hover:bg-green-500/10 hover:text-green-500 text-slate-400`}><Icon name="copy"/></button>
                                                
                                                <button onClick={() => db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('drafts').doc(d.id).delete()} className="p-2 rounded hover:bg-red-500/10 hover:text-red-500 text-slate-400"><Icon name="trash2"/></button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        // --- SUB COMPONENTS ---

        function AuthScreen({ auth, error, setError }) {
            const [isReg, setIsReg] = useState(false);
            const [email, setEmail] = useState("");
            const [pass, setPass] = useState("");
            const [busy, setBusy] = useState(false);

            const submit = async (e) => {
                e.preventDefault();
                setBusy(true); setError(null);
                try {
                    if(isReg) await auth.createUserWithEmailAndPassword(email, pass);
                    else await auth.signInWithEmailAndPassword(email, pass);
                } catch(err) {
                    if (err.code === 'auth/operation-not-allowed') setError("Email Login is disabled in Firebase Console.");
                    else if (err.code === 'auth/email-already-in-use') { setError("Email used. Log in instead."); setIsReg(false); }
                    else setError(err.message);
                } finally { setBusy(false); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-900 text-white p-4">
                    <div className="max-w-sm w-full bg-slate-800 p-8 rounded-2xl border border-slate-700 shadow-2xl">
                        <div className="text-center mb-6">
                            <h1 className="text-2xl font-bold mb-2">POP! Planner</h1>
                            <p className="text-sm text-slate-400">Sync your drafts everywhere</p>
                        </div>
                        <form onSubmit={submit} className="space-y-4">
                            <input className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none" type="email" placeholder="Email" required value={email} onChange={e=>setEmail(e.target.value)} />
                            <input className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none" type="password" placeholder="Password" required value={pass} onChange={e=>setPass(e.target.value)} />
                            {error && <div className="text-xs text-red-400 bg-red-500/10 p-2 rounded">{error}</div>}
                            <button disabled={busy} className="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-bold transition-colors">{busy ? '...' : (isReg ? 'Create Account' : 'Log In')}</button>
                        </form>
                        <button onClick={()=>setIsReg(!isReg)} className="w-full mt-4 text-xs text-slate-400 hover:text-white underline">{isReg ? 'Login instead' : 'Create new account'}</button>
                    </div>
                </div>
            )
        }

        function ErrorScreen({ type, config }) {
            const isPerm = type === 'permission';
            const isMissing = type === 'not-found';
            const link = isPerm 
                ? `https://console.firebase.google.com/project/${config.projectId}/firestore/rules`
                : `https://console.firebase.google.com/project/${config.projectId}/firestore`;

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-900 text-white p-4 text-center">
                    <div className="max-w-md bg-slate-800 p-8 rounded-2xl border border-slate-700">
                        <div className="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500">
                            <Icon name={isPerm ? "lock" : "database"} size={32} />
                        </div>
                        <h2 className="text-xl font-bold mb-2">{isPerm ? "Database Locked" : "Create Database"}</h2>
                        <p className="text-sm text-slate-400 mb-6">
                            {isPerm ? "You need to enable 'Test Mode' in Firestore Rules." : "The database hasn't been created in Firebase Console yet."}
                        </p>
                        <a href={link} target="_blank" className="block w-full bg-blue-600 py-2 rounded-lg font-bold mb-2">Go to Console</a>
                        <button onClick={()=>window.location.reload()} className="block w-full bg-slate-700 py-2 rounded-lg font-bold">I Fixed It, Refresh</button>
                    </div>
                </div>
            )
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
