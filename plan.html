<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pop! Planner</title>
    
    <!-- 1. Load React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 2. Load Babel (to understand JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. Load Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 4. Load Firebase (Compat version for HTML usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* Custom scrollbar for cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyD-8NTdlSAaVumj4WWRd0hO1x49D8s3Zgw",
            authDomain: "planner-bcd70.firebaseapp.com",
            projectId: "planner-bcd70",
            storageBucket: "planner-bcd70.firebasestorage.app",
            messagingSenderId: "56263069136",
            appId: "1:56263069136:web:89f22b5c45c566e13c3dd5",
            measurementId: "G-V6ZD0QP9QN"
        };
        
        // --- APP LOGIC STARTS HERE ---
        
        // Initialize Firebase
        let auth, db;
        // Simple check to ensure we aren't using placeholders
        const isConfigured = firebaseConfig.apiKey && firebaseConfig.apiKey !== "AIzaSyYOUR_API_KEY_HERE";

        if (isConfigured) {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            auth = firebase.auth();
            db = firebase.firestore();
        }

        const appId = "pop-planner-web"; 
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icon = ({ name, size = 18, className = "" }) => {
            const icons = {
                plus: <path d="M5 12h14M12 5v14" />,
                image: <><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><circle cx="9" cy="9" r="2" /><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" /></>,
                x: <path d="M18 6 6 18M6 6l12 12" />,
                trash2: <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6" />,
                copy: <><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></>,
                layoutGrid: <><rect width="7" height="7" x="3" y="3" rx="1" /><rect width="7" height="7" x="14" y="3" rx="1" /><rect width="7" height="7" x="14" y="14" rx="1" /><rect width="7" height="7" x="3" y="14" rx="1" /></>,
                list: <><line x1="8" x2="21" y1="6" y2="6" /><line x1="8" x2="21" y1="12" y2="12" /><line x1="8" x2="21" y1="18" y2="18" /><line x1="3" x2="3.01" y1="6" y2="6" /><line x1="3" x2="3.01" y1="12" y2="12" /><line x1="3" x2="3.01" y1="18" y2="18" /></>,
                save: <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></>,
                moon: <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />,
                sun: <><circle cx="12" cy="12" r="4" /><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41" /></>,
                cloud: <><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19" /><path d="M19 19H5a3 3 0 1 1 .55-5.94A7 7 0 1 1 19 19Z" /></>,
                wifi: <><path d="M5 12.55a11 11 0 0 1 14.08 0" /><path d="M1.42 9a16 16 0 0 1 21.16 0" /><path d="M8.53 16.11a6 6 0 0 1 6.95 0" /><line x1="12" x2="12.01" y1="20" y2="20" /></>,
                wifiOff: <><line x1="1" x2="23" y1="1" y2="23" /><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55" /><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39" /><path d="M10.71 5.05A16 16 0 0 1 22.58 9" /><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88" /><path d="M8.53 16.11a6 6 0 0 1 6.95 0" /><line x1="12" x2="12.01" y1="20" y2="20" /></>,
                twitter: <path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.6 5.6 4.1 9 4-.9-4.2 4-6.6 7-3.8 1.1 0 3-1.2 3-1.2z" />,
                hash: <><line x1="4" x2="20" y1="9" y2="9" /><line x1="4" x2="20" y1="15" y2="15" /><line x1="10" x2="8" y1="3" y2="21" /><line x1="16" x2="14" y1="3" y2="21" /></>,
                link: <><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></>,
                zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />,
                star: <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />,
                tag: <><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z" /><path d="M7 7h.01" /></>,
                database: <><ellipse cx="12" cy="5" rx="9" ry="3" /><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" /><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" /></>,
                clock: <><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></>,
                lock: <><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>
            };

            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className}
                >
                    {icons[name]}
                </svg>
            );
        };

        // --- CONSTANTS ---
        const DEFAULT_TAGS = "\n\n#Ad #FPN #FunkoPOPNews #Funko #FunkoPOP";
        const QUICK_LINKS = [
            { name: 'EE', url: ' fnkpp.com/EE ', color: 'bg-purple-100 text-purple-700 border-purple-200' },
            { name: 'Funko Shop', url: ' fnkpp.com/FS ', color: 'bg-blue-100 text-blue-700 border-blue-200' },
            { name: 'Hot Topic', url: ' fnkpp.com/HT ', color: 'bg-red-100 text-red-700 border-red-200' },
            { name: 'Box Lunch', url: ' fnkpp.com/BL ', color: 'bg-teal-100 text-teal-700 border-teal-200' },
            { name: 'Amazon', url: ' fnkpp.com/Amzn ', color: 'bg-yellow-100 text-yellow-700 border-yellow-200' },
        ];
        const RETAILERS = [
            { keyword: 'target', label: 'Target', color: 'bg-red-600 text-white' },
            { keyword: 'amazon', label: 'Amazon', color: 'bg-yellow-500 text-black' },
            { keyword: 'hot topic', label: 'Hot Topic', color: 'bg-zinc-800 text-white' },
            { keyword: 'box lunch', label: 'Box Lunch', color: 'bg-teal-600 text-white' },
            { keyword: 'entertainment earth', label: 'EE', color: 'bg-purple-600 text-white' },
            { keyword: 'ee', label: 'EE', color: 'bg-purple-600 text-white' },
            { keyword: 'funko shop', label: 'Funko Shop', color: 'bg-blue-600 text-white' },
            { keyword: 'walmart', label: 'Walmart', color: 'bg-blue-500 text-white' },
        ];

        // --- MAIN APP COMPONENT ---
        function App() {
            // Configuration Guard
            if (!isConfigured) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-900 text-white p-4 font-sans">
                        <div className="max-w-lg bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700 text-center">
                            <div className="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
                                <Icon name="zap" size={32} className="text-red-500" />
                            </div>
                            <h1 className="text-2xl font-bold mb-4 text-white">Setup Required</h1>
                            <p className="mb-6 text-slate-400 leading-relaxed">
                                The app is almost ready! You need to add your Firebase API keys to the code to enable Cloud Storage.
                            </p>
                            
                            <div className="bg-slate-900 p-4 rounded-xl text-left mb-6 border border-slate-700">
                                <ol className="list-decimal pl-5 space-y-2 text-sm text-slate-300">
                                    <li>Open <span className="text-blue-400 font-mono">index.html</span> in your GitHub editor.</li>
                                    <li>Find the line: <span className="text-yellow-400 font-mono">const firebaseConfig = ...</span></li>
                                    <li>Replace the placeholder keys with your real keys from the Firebase Console.</li>
                                    <li>Commit the changes and refresh this page.</li>
                                </ol>
                            </div>

                            <a href="https://console.firebase.google.com" target="_blank" className="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-colors">
                                Go to Firebase Console &rarr;
                            </a>
                        </div>
                    </div>
                );
            }

            const [drafts, setDrafts] = useState([]);
            const [inputText, setInputText] = useState("");
            const [selectedImage, setSelectedImage] = useState(null);
            const [viewMode, setViewMode] = useState("grid");
            const [darkMode, setDarkMode] = useState(true);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const [pasteActive, setPasteActive] = useState(false);
            const [isPriority, setIsPriority] = useState(false);
            const [useWatermark, setUseWatermark] = useState(false);
            const [authError, setAuthError] = useState(null);
            const [firestoreError, setFirestoreError] = useState(null);
            const [permissionError, setPermissionError] = useState(false);
            const [timeoutError, setTimeoutError] = useState(false);

            const fileInputRef = useRef(null);
            const textareaRef = useRef(null);

            // Auth
            useEffect(() => {
                if (!auth) return;
                const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                        setAuthError(null);
                    } else {
                        // Auto sign in anonymously
                        try {
                            await auth.signInAnonymously();
                        } catch (e) {
                            console.error("Auth error", e);
                            setAuthError(e.message);
                        }
                    }
                });
                return () => unsubscribe();
            }, []);

            // Data Sync with Timeout Check
            useEffect(() => {
                if (!user || !db) return;
                setLoading(true);
                setTimeoutError(false);
                setPermissionError(false);

                // Setup connection timeout
                const connectionTimer = setTimeout(() => {
                    setTimeoutError(true);
                }, 10000); // 10 seconds

                const draftsRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('drafts');
                
                const unsubscribe = draftsRef.onSnapshot((snapshot) => {
                    clearTimeout(connectionTimer); // Connected successfully
                    const fetchedDrafts = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    fetchedDrafts.sort((a, b) => {
                        if (a.isPriority === b.isPriority) return b.createdAt - a.createdAt;
                        return b.isPriority ? 1 : -1;
                    });
                    
                    setDrafts(fetchedDrafts);
                    setLoading(false);
                    setFirestoreError(null);
                    setTimeoutError(false);
                    setPermissionError(false);
                }, (error) => {
                    clearTimeout(connectionTimer);
                    console.error("Firestore sync error:", error);
                    if (error.code === 'permission-denied') {
                        setPermissionError(true);
                    } else {
                        setFirestoreError(error.message);
                    }
                    setLoading(false);
                });

                return () => {
                    unsubscribe();
                    clearTimeout(connectionTimer);
                };
            }, [user]);

            // Logic Helpers
            const processImage = (base64Str, applyWatermark) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = base64Str;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const maxWidth = 1000;
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        if (applyWatermark) {
                            const text = "@FunkoPOPsNews";
                            const fontSize = Math.max(20, width * 0.05);
                            ctx.font = `bold ${fontSize}px sans-serif`;
                            ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
                            ctx.strokeStyle = "rgba(0, 0, 0, 0.5)";
                            ctx.lineWidth = 4;
                            ctx.textAlign = "right";
                            ctx.textBaseline = "bottom";
                            const padding = width * 0.03;
                            ctx.strokeText(text, width - padding, height - padding);
                            ctx.fillText(text, width - padding, height - padding);
                        }
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                });
            };

            const handlePaste = async (e) => {
                if (e.clipboardData.items) {
                    const items = e.clipboardData.items;
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf("image") !== -1) {
                            e.preventDefault();
                            setPasteActive(true);
                            const blob = items[i].getAsFile();
                            const reader = new FileReader();
                            reader.onload = async (event) => {
                                const processed = await processImage(event.target.result, false);
                                setSelectedImage(processed);
                                setPasteActive(false);
                            };
                            reader.readAsDataURL(blob);
                            return;
                        }
                    }
                }
            };

            useEffect(() => {
                window.addEventListener('paste', handlePaste);
                return () => window.removeEventListener('paste', handlePaste);
            }, []);

            const handleAddDraft = async () => {
                if ((!inputText.trim() && !selectedImage) || !user) return;
                setIsSaving(true);
                try {
                    let finalImage = selectedImage;
                    if (selectedImage && useWatermark) {
                        finalImage = await processImage(selectedImage, true);
                    }
                    const newDraft = {
                        text: inputText,
                        image: finalImage,
                        date: new Date().toLocaleString(),
                        createdAt: Date.now(),
                        isPriority: isPriority,
                        status: 'draft'
                    };
                    await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('drafts').add(newDraft);
                    setInputText("");
                    setSelectedImage(null);
                    setIsPriority(false);
                    setUseWatermark(false);
                    if (fileInputRef.current) fileInputRef.current.value = "";
                } catch (err) { console.error(err); alert("Save failed"); } 
                finally { setIsSaving(false); }
            };

            const handleImageChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const processed = await processImage(reader.result, false);
                        setSelectedImage(processed);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const insertLink = (link) => {
                const cursorPos = textareaRef.current.selectionStart;
                const textBefore = inputText.substring(0, cursorPos);
                const textAfter = inputText.substring(cursorPos);
                setInputText(`${textBefore}${link}${textAfter}`);
                textareaRef.current.focus();
            };

            const useFirstLookTemplate = () => {
                setInputText(`ðŸš¨ FIRST LOOK! New Funko POPs revealed:\n\n[Details Here]\n${DEFAULT_TAGS}`);
            };

            const insertHashtags = () => {
                setInputText(prev => prev + DEFAULT_TAGS);
                textareaRef.current.focus();
            };

            const deleteDraft = async (docId) => {
                if (!user) return;
                try { await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('drafts').doc(docId).delete(); } catch (e) {}
            };

            const togglePriority = async (docId, currentVal) => {
                if (!user) return;
                try { await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('drafts').doc(docId).update({ isPriority: !currentVal }); } catch (e) {}
            };

            const copyToClipboard = (text) => {
                if (!text) return;
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            };

            const postToTwitter = (text) => {
                if (!text) return;
                const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
                window.open(twitterUrl, '_blank');
            };

            const retryAuth = async () => {
                setAuthError(null);
                setFirestoreError(null); // Clear both
                setTimeoutError(false);
                setPermissionError(false);
                try {
                    await auth.signInAnonymously();
                } catch (e) {
                    console.error("Retry failed", e);
                    setAuthError(e.message);
                }
            };

            const getRetailerBadge = (text) => {
                if (!text) return null;
                const lowerText = text.toLowerCase();
                const match = RETAILERS.find(r => lowerText.includes(r.keyword));
                if (match) {
                    return <span className={`text-[10px] uppercase font-bold px-2 py-0.5 rounded-full ${match.color} shadow-sm`}>{match.label}</span>;
                }
                return null;
            };

            // If we have an auth error (like missing config in console), show instructions
            if (authError) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-900 text-white p-4 font-sans">
                        <div className="max-w-lg bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700 text-center">
                             <div className="w-16 h-16 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
                                <Icon name="zap" size={32} className="text-yellow-500" />
                            </div>
                            <h1 className="text-2xl font-bold mb-4 text-white">One More Step!</h1>
                            <p className="mb-6 text-slate-400 leading-relaxed">
                                Your app is deployed, but Firebase Authentication isn't enabled yet in the Console.
                            </p>
                             <div className="bg-slate-900 p-4 rounded-xl text-left mb-6 border border-slate-700">
                                <ol className="list-decimal pl-5 space-y-2 text-sm text-slate-300">
                                    <li>Go to the <span className="text-blue-400 font-bold">Firebase Console</span>.</li>
                                    <li>Click <span className="text-yellow-400 font-mono">Build</span> -> <span className="text-yellow-400 font-mono">Authentication</span>.</li>
                                    <li>Click <strong>Get Started</strong>.</li>
                                    <li>Go to the <strong>Sign-in method</strong> tab.</li>
                                    <li>Click <strong>Anonymous</strong> and switch it to <strong>Enable</strong>.</li>
                                </ol>
                            </div>
                            <div className="flex flex-col gap-3">
                                <a href="https://console.firebase.google.com" target="_blank" className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-colors">
                                    Go to Firebase Console &rarr;
                                </a>
                                <button onClick={retryAuth} className="bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-xl transition-colors">
                                    Retry Connection
                                </button>
                            </div>
                            <p className="mt-4 text-xs text-slate-500 font-mono">{authError}</p>
                        </div>
                    </div>
                );
            }

            // If we have a Firestore error (Database not created), show instructions
            if (firestoreError || timeoutError) {
                 const projectId = firebaseConfig.projectId;
                 const setupLink = `https://console.firebase.google.com/project/${projectId}/firestore`;
                 
                 return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-900 text-white p-4 font-sans">
                        <div className="max-w-lg bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700 text-center">
                             <div className="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
                                {timeoutError ? <Icon name="clock" size={32} className="text-red-500" /> : <Icon name="database" size={32} className="text-red-500" />}
                            </div>
                            <h1 className="text-2xl font-bold mb-4 text-white">Create Database</h1>
                            <p className="mb-6 text-slate-400 leading-relaxed">
                                {timeoutError 
                                    ? "Connection timed out. This usually means the Firestore Database hasn't been created yet."
                                    : "You are signed in, but the database doesn't exist yet! You need to create it in the Firebase Console."}
                            </p>
                             <div className="bg-slate-900 p-4 rounded-xl text-left mb-6 border border-slate-700">
                                <ol className="list-decimal pl-5 space-y-2 text-sm text-slate-300">
                                    <li>Click the <strong>Go to Database Setup</strong> button below.</li>
                                    <li>Click <strong>Create Database</strong>.</li>
                                    <li>Choose a location (e.g., nam5).</li>
                                    <li>Select <strong>Start in Test Mode</strong> (Important!).</li>
                                    <li>Click <strong>Create</strong>.</li>
                                </ol>
                            </div>
                            <div className="flex flex-col gap-3">
                                <a href={setupLink} target="_blank" className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-colors flex items-center justify-center gap-2">
                                    <Icon name="link" size={18} /> Go to Database Setup
                                </a>
                                <button onClick={() => window.location.reload()} className="bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-xl transition-colors">
                                    I did this, Refresh Page
                                </button>
                            </div>
                            <p className="mt-4 text-xs text-slate-500 font-mono break-all">{firestoreError || "Timeout Error"}</p>
                        </div>
                    </div>
                );
            }

            // PERMISSION ERROR SCREEN (New)
            if (permissionError) {
                 const projectId = firebaseConfig.projectId;
                 const rulesLink = `https://console.firebase.google.com/project/${projectId}/firestore/rules`;
                 
                 return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-900 text-white p-4 font-sans">
                        <div className="max-w-lg bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700 text-center">
                             <div className="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
                                <Icon name="lock" size={32} className="text-red-500" />
                            </div>
                            <h1 className="text-2xl font-bold mb-4 text-white">Database Locked</h1>
                            <p className="mb-6 text-slate-400 leading-relaxed">
                                Your database is online, but <strong>Security Rules</strong> are blocking access.
                            </p>
                             <div className="bg-slate-900 p-4 rounded-xl text-left mb-6 border border-slate-700">
                                <ol className="list-decimal pl-5 space-y-2 text-sm text-slate-300">
                                    <li>Click the button below to go to <strong>Firestore Rules</strong>.</li>
                                    <li>Delete the existing code in the editor.</li>
                                    <li>Paste this code:<br/><code className="block mt-2 bg-slate-800 p-2 rounded text-xs text-green-400">allow read, write: if request.auth != null;</code></li>
                                    <li>Click <strong>Publish</strong>.</li>
                                </ol>
                            </div>
                            <div className="flex flex-col gap-3">
                                <a href={rulesLink} target="_blank" className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-colors flex items-center justify-center gap-2">
                                    <Icon name="link" size={18} /> Update Rules
                                </a>
                                <button onClick={() => window.location.reload()} className="bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-xl transition-colors">
                                    I Fixed It, Refresh Page
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // RENDER
            return (
                <div className={`min-h-screen transition-colors duration-300 ${darkMode ? 'bg-slate-900 text-slate-100' : 'bg-slate-50 text-slate-900'}`}>
                    
                    {pasteActive && (
                        <div className="fixed inset-0 z-50 bg-blue-500/20 backdrop-blur-sm flex items-center justify-center pointer-events-none">
                            <div className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold text-xl shadow-xl animate-bounce">
                                Processing Image...
                            </div>
                        </div>
                    )}

                    {/* Navbar */}
                    <nav className={`sticky top-0 z-40 border-b backdrop-blur-md ${darkMode ? 'bg-slate-900/80 border-slate-700' : 'bg-white/80 border-slate-200'}`}>
                        <div className="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center transform -rotate-6 shadow-lg">
                                    <span className="text-white font-black text-lg">P!</span>
                                </div>
                                <h1 className="font-bold text-xl tracking-tight hidden sm:block">Pop! Planner</h1>
                                <div className={`ml-2 px-2 py-0.5 rounded-full text-xs font-medium flex items-center gap-1 ${user ? 'bg-green-500/10 text-green-500' : 'bg-yellow-500/10 text-yellow-500'}`}>
                                    <Icon name={user ? "wifi" : "wifiOff"} size={12} />
                                    <span className="hidden xs:inline">{user ? 'Cloud Sync' : 'Offline'}</span>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-4">
                                <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-full transition-colors ${darkMode ? 'hover:bg-slate-800 text-slate-400' : 'hover:bg-slate-100 text-slate-500'}`}>
                                    <Icon name={darkMode ? "sun" : "moon"} size={20} />
                                </button>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-6xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
                        
                        {/* Composer */}
                        <div className="lg:col-span-4 xl:col-span-4">
                            <div className={`sticky top-24 rounded-2xl p-4 shadow-xl border ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                
                                <div className="flex justify-between items-start mb-4">
                                    <h2 className="font-semibold flex items-center gap-2">
                                        <Icon name="plus" size={18} className="text-blue-500" /> New Idea
                                    </h2>
                                    <button onClick={useFirstLookTemplate} className="text-xs bg-purple-500/10 text-purple-500 hover:bg-purple-500/20 px-2 py-1 rounded-md font-medium transition-colors flex items-center gap-1">
                                        <Icon name="zap" size={12} /> First Look
                                    </button>
                                </div>
                                
                                {selectedImage && (
                                    <div className="relative mb-4 group animate-in fade-in zoom-in duration-300">
                                        <img src={selectedImage} alt="Preview" className="w-full h-48 object-cover rounded-xl border border-slate-600/20" />
                                        <button onClick={() => setSelectedImage(null)} className="absolute top-2 right-2 bg-black/70 hover:bg-red-500 text-white p-1.5 rounded-full transition-colors backdrop-blur-sm">
                                            <Icon name="x" size={14} />
                                        </button>
                                    </div>
                                )}

                                <div className="relative">
                                    <textarea
                                        ref={textareaRef}
                                        value={inputText}
                                        onChange={(e) => setInputText(e.target.value)}
                                        placeholder="Paste details or images here..."
                                        className={`w-full h-40 p-3 pb-10 rounded-xl resize-none mb-3 focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all ${darkMode ? 'bg-slate-900/50 border-slate-700 placeholder-slate-500 text-white' : 'bg-slate-50 border-slate-200 placeholder-slate-400 text-slate-900'} border`}
                                    />
                                    <div className="absolute bottom-4 right-2 flex gap-2">
                                        <button onClick={insertHashtags} title="Add hashtags" className={`p-1.5 rounded-md text-xs font-bold transition-colors ${darkMode ? 'bg-slate-800 text-blue-400 hover:bg-blue-900/50' : 'bg-white text-blue-600 hover:bg-blue-50 shadow-sm border border-slate-200'}`}>
                                            <Icon name="hash" size={14} />
                                        </button>
                                    </div>
                                </div>

                                <div className="mb-4">
                                    <p className="text-xs font-semibold text-slate-500 mb-2 uppercase tracking-wider flex items-center gap-1">
                                        <Icon name="link" size={12} /> Quick Links
                                    </p>
                                    <div className="flex flex-wrap gap-2">
                                        {QUICK_LINKS.map((link) => (
                                            <button key={link.name} onClick={() => insertLink(link.url)} className={`text-xs px-2 py-1 rounded border transition-transform active:scale-95 ${link.color}`}>
                                                {link.name}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div className="flex gap-4 mb-4">
                                    <button onClick={() => setIsPriority(!isPriority)} className={`flex-1 py-2 rounded-lg text-sm font-medium border flex items-center justify-center gap-2 transition-colors ${isPriority ? 'bg-red-500/10 text-red-500 border-red-500/50' : darkMode ? 'border-slate-700 text-slate-400 hover:bg-slate-700' : 'border-slate-200 text-slate-600 hover:bg-slate-100'}`}>
                                        <Icon name="star" size={16} className={isPriority ? "fill-current" : ""} /> {isPriority ? 'Priority' : 'Normal'}
                                    </button>
                                    <button onClick={() => setUseWatermark(!useWatermark)} className={`flex-1 py-2 rounded-lg text-sm font-medium border flex items-center justify-center gap-2 transition-colors ${useWatermark ? 'bg-blue-500/10 text-blue-500 border-blue-500/50' : darkMode ? 'border-slate-700 text-slate-400 hover:bg-slate-700' : 'border-slate-200 text-slate-600 hover:bg-slate-100'}`}>
                                        <Icon name="tag" size={16} /> {useWatermark ? 'Watermark' : 'No Mark'}
                                    </button>
                                </div>

                                <div className="flex gap-2">
                                    <button onClick={() => fileInputRef.current.click()} className={`p-3 rounded-xl transition-colors flex items-center justify-center border ${darkMode ? 'border-slate-700 hover:bg-slate-700' : 'border-slate-200 hover:bg-slate-50'}`}>
                                        <Icon name="image" size={20} className={selectedImage ? 'text-green-500' : 'text-slate-400'} />
                                    </button>
                                    <input type="file" ref={fileInputRef} onChange={handleImageChange} className="hidden" accept="image/*" />

                                    <button onClick={handleAddDraft} disabled={(!inputText.trim() && !selectedImage) || isSaving} className={`flex-1 rounded-xl font-bold transition-all transform active:scale-95 flex items-center justify-center gap-2 ${(!inputText.trim() && !selectedImage) || isSaving ? 'bg-slate-700/50 text-slate-500 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600 text-white shadow-lg shadow-blue-500/20'}`}>
                                        {isSaving ? <Icon name="loader2" size={18} className="animate-spin" /> : <Icon name="save" size={18} />}
                                        {isSaving ? 'Saving...' : 'Save Draft'}
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Feed */}
                        <div className="lg:col-span-8 xl:col-span-8">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold flex items-center gap-2">
                                    Your Drafts {loading && <Icon name="loader2" size={16} className="animate-spin text-slate-500" />}
                                </h2>
                                <div className={`flex p-1 rounded-lg border ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                    <button onClick={() => setViewMode('grid')} className={`p-1.5 rounded-md ${viewMode === 'grid' ? (darkMode ? 'bg-slate-700' : 'bg-slate-100') : 'text-slate-500'}`}><Icon name="layoutGrid" size={18} /></button>
                                    <button onClick={() => setViewMode('list')} className={`p-1.5 rounded-md ${viewMode === 'list' ? (darkMode ? 'bg-slate-700' : 'bg-slate-100') : 'text-slate-500'}`}><Icon name="list" size={18} /></button>
                                </div>
                            </div>

                            {!user ? (
                                <div className="text-center py-20 text-slate-500">Connecting to Cloud...</div>
                            ) : drafts.length === 0 && !loading ? (
                                <div className="text-center py-20 text-slate-500 border-2 border-dashed rounded-3xl border-slate-700">No drafts found.</div>
                            ) : (
                                <div className={viewMode === 'grid' ? 'grid grid-cols-1 md:grid-cols-2 gap-6' : 'space-y-4'}>
                                    {drafts.map((draft) => (
                                        <div key={draft.id} className={`group relative overflow-hidden rounded-2xl border transition-all duration-200 hover:shadow-xl ${darkMode ? 'bg-slate-800 border-slate-700 hover:border-slate-600' : 'bg-white border-slate-200 hover:border-blue-200'} ${draft.isPriority ? 'ring-2 ring-red-500/50 border-red-500/30' : ''}`}>
                                            {draft.isPriority && (
                                                <div className="absolute top-2 left-2 z-10 bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded-full flex items-center gap-1 shadow-lg">
                                                    <Icon name="star" size={10} className="fill-current" /> PRIORITY
                                                </div>
                                            )}

                                            <div className={viewMode === 'list' ? 'flex flex-row' : 'flex flex-col'}>
                                                {draft.image && (
                                                    <div className={`relative overflow-hidden ${viewMode === 'list' ? 'w-48 h-auto shrink-0' : 'w-full h-56'}`}>
                                                        <img src={draft.image} alt="Draft attachment" className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" />
                                                    </div>
                                                )}

                                                <div className="p-5 flex flex-col flex-grow">
                                                    <div className="mb-2 flex gap-2">
                                                        {getRetailerBadge(draft.text)}
                                                    </div>

                                                    <div className="flex-grow">
                                                        <p className={`whitespace-pre-wrap leading-relaxed text-sm ${!draft.text ? 'italic opacity-50' : ''}`}>
                                                            {draft.text || "No text content"}
                                                        </p>
                                                    </div>
                                                    
                                                    <div className={`mt-4 pt-4 flex justify-between items-center border-t ${darkMode ? 'border-slate-700' : 'border-slate-100'}`}>
                                                        <span className="text-xs font-medium text-slate-500">{draft.date}</span>
                                                        <div className="flex gap-2">
                                                            <button onClick={() => togglePriority(draft.id, draft.isPriority)} className={`p-2 rounded-lg ${draft.isPriority ? 'text-red-500' : 'text-slate-500 hover:text-red-500'}`} title="Toggle Priority"><Icon name="star" size={16} className={draft.isPriority ? "fill-current" : ""} /></button>
                                                            <button onClick={() => postToTwitter(draft.text)} className="p-2 rounded-lg text-slate-400 hover:text-blue-500" title="Post to X"><Icon name="twitter" size={16} /></button>
                                                            <button onClick={() => copyToClipboard(draft.text)} className="p-2 rounded-lg text-slate-400 hover:text-blue-500" title="Copy"><Icon name="copy" size={16} /></button>
                                                            <button onClick={() => deleteDraft(draft.id)} className="p-2 rounded-lg text-slate-400 hover:text-red-500" title="Delete"><Icon name="trash2" size={16} /></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
